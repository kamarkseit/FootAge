<!DOCTYPE html>
<html>

<head>
    <title>Walk Recorder</title>
</head>

<body>
    <h1>Record Your Walk</h1>
    <video id="preview" autoplay muted></video>
    <br>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <script>
        let mediaRecorder;
        let recordedChunks = [];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const preview = document.getElementById('preview');

        startBtn.onclick = async () => {
            recordedChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            preview.srcObject = stream;

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const file = new File([blob], 'walk_video.webm');

                // Send to backend to get presigned URL
                const res = await fetch('/get-presigned-url', {
                    method: 'POST',
                    body: JSON.stringify({ filename: file.name }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const { url } = await res.json();

                // Upload to S3
                await fetch(url, {
                    method: 'PUT',
                    body: file
                });

                alert('âœ… Video uploaded!');
            };

            mediaRecorder.start();
            stopBtn.disabled = false;
            startBtn.disabled = true;

            // Auto-stop after 1 minute
            setTimeout(() => {
                if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            }, 60000);
        };

        stopBtn.onclick = () => {
            if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            stopBtn.disabled = true;
            startBtn.disabled = false;
        };
    </script>
</body>

</html>