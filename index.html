<!DOCTYPE html>
<html>

<head>
    <title>FootAge Recorder</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
    <h1>Record Your Walk</h1>
    <video id="preview" autoplay muted></video>
    <br>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <h2>Detection Summary</h2>
    <div id="bottle-count">Let's see how many bottles we can spot!</div>
    <div id="bottle-gallery"></div>


    <script>
        let mediaRecorder;
        let recordedChunks = [];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const preview = document.getElementById('preview');

        let idStartTime;
        let startTime, stopTime;

        let urls = [
            `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
        ];

        startBtn.onclick = async () => {
            idStartTime = getFormattedTimestamp();
            document.getElementById("bottle-gallery").innerHTML = "";
            document.getElementById("bottle-count").textContent =
                "Recording video now.";
            recordedChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: true });
            preview.srcObject = stream;

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                stopBtn.disabled = true;
                startBtn.disabled = true;
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('video', blob, 'walk_video.webm');
                formData.append('id', idStartTime);

                // ‚úÖ This is where your fetch() call goes
                fetch('https://footage-backend.onrender.com/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.text())
                    .then(data => alert('‚úÖ Video uploaded and processed'))
                    .catch(error => alert('‚ùå Upload failed: ' + error));
            };

            mediaRecorder.start();
            startTime = Date.now();
            stopBtn.disabled = false;
            startBtn.disabled = true;

            setTimeout(() => {
                if ((stopBtn.disabled == false) && (startBtn.disabled == true)) {
                    if (mediaRecorder.state === 'recording') mediaRecorder.stop();

                    document.getElementById("bottle-count").textContent =
                        "Your video reached the maximum length. Processing. Please do not refresh.";

                    stopTime = Date.now();
                    const durationMs = stopTime - startTime;
                    const durationSec = durationMs / 1000 - 0.025;
                    const x = Math.floor(durationSec / 30) + 1; // number of 30-second segments

                    stopBtn.disabled = true;
                    startBtn.disabled = true;

                    urls = [
                        `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
                    ];
                    pollForResults();
                };
            }, 30000);
        };

        stopBtn.onclick = () => {
            if (mediaRecorder.state === 'recording') mediaRecorder.stop();

            document.getElementById("bottle-count").textContent =
                "Processing. Please do not refresh.";

            stopTime = Date.now();
            const durationMs = stopTime - startTime;
            const durationSec = durationMs / 1000 - 0.025;
            const x = Math.floor(durationSec / 0.5) + 1; // number of 30-second segments

            stopBtn.disabled = true;
            startBtn.disabled = true;

            urls = [
                `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
            ];
            pollForResults();

        };

        // Functions to fetch json results and display it.
        async function tryFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                return null;
            }
        }

        async function pollForResults(interval = 10000, maxAttempts = 60) {
            let attempts = 0;

            while (attempts < maxAttempts) {
                for (const url of urls) {
                    const data = await tryFetch(url);
                    if (data) {
                        //Find number of bottles detected
                        const uniqueIds = new Set();
                        data.forEach(frame => {
                            frame.tracker_ids.forEach(id => uniqueIds.add(id));
                        });
                        const count = uniqueIds.size;
                        //Find the best images to display
                        const bestImages = {};
                        data.forEach(frame => {
                            frame.tracker_ids.forEach((id, index) => {
                                const confidence = frame.confidences[index];
                                const imageUrl = frame.image_url;

                                if (!bestImages[id] || confidence > bestImages[id].confidence) {
                                    bestImages[id] = {
                                        confidence,
                                        imageUrl,
                                        frame: frame.frame
                                    };
                                }
                            });
                        });
                        //Display the best images
                        const gallery = document.getElementById("bottle-gallery");
                        Object.entries(bestImages).forEach(([id, info]) => {
                            const img = document.createElement("img");
                            img.src = info.imageUrl;
                            img.alt = `Bottle ${id}`;
                            img.title = `Confidence: ${info.confidence}`;
                            img.style.width = "150px";
                            img.style.margin = "10px";
                            gallery.appendChild(img);
                        });
                        //Display total detections found
                        document.getElementById("bottle-count").textContent =
                            `üçº Total bottles detected: ${count}`;
                        stopBtn.disabled = true;
                        startBtn.disabled = false;
                        return;
                    }
                }
                attempts++;
                console.log(`üîÑ Attempt ${attempts}: JSON not yet available`);
                await new Promise(resolve => setTimeout(resolve, interval));
            }
            document.getElementById("bottle-count").textContent =
                "‚ö†Ô∏è Detection results not found after waiting.";

            stopBtn.disabled = true;
            startBtn.disabled = false;
        }


        // Function to get the right date and time id for fetching.
        function getFormattedTimestamp() {
            // get the current time and store it in a variable.
            let now = new Date();
            // move the time ahead 7 hours to account for time difference.
            now.setHours(now.getHours() + 7)
            //  move the month ahead 1 month (to account for a zero based index)
            now.setMonth(now.getMonth() + 1);
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()).padStart(2, '0'); // Months are 0-indexed
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const sec = String(now.getSeconds()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd}_${hh}-${min}-${sec}`;
        }

    </script>
</body>

</html>