<!DOCTYPE html>
<html>

<head>
    <title>FootAge Recorder</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
    <h1>Record Your Walk</h1>
    <video id="preview" autoplay muted></video>
    <br>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <h2>Detection Summary</h2>
    <div id="bottle-count">Let's see how many bottles we can spot!</div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const preview = document.getElementById('preview');

        let idStartTime;
        let startTime, stopTime;

        let urls = [
            `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
        ];

        startBtn.onclick = async () => {
            startTime = Date.now()
            idStartTime = getFormattedTimestamp();
            console.log("MY STARTIME ID", idStartTime);

            document.getElementById("bottle-count").textContent =
                "Loading...";
            recordedChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: true });
            preview.srcObject = stream;

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('video', blob, 'walk_video.webm');
                formData.append('id', idStartTime);

                // ‚úÖ This is where your fetch() call goes
                fetch('https://footage-backend.onrender.com/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.text())
                    .then(data => alert('‚úÖ Video uploaded and processed'))
                    .catch(error => alert('‚ùå Upload failed: ' + error));
            };

            mediaRecorder.start();
            stopBtn.disabled = false;
            startBtn.disabled = true;

            setTimeout(() => {
                if ((stopBtn.disabled = false) && (startBtn.disabled = true)) {
                    stopTime = Date.now();
                    const durationMs = stopTime - startTime;
                    const durationSec = durationMs / 1000;
                    const x = Math.floor(durationSec / 30) - 1; // number of 30-second segments
                    console.log("Start time", startTime);
                    console.log("Stop time", stopTime);
                    console.log("DURATION IN MS:", durationMs);
                    console.log("DURATION IN SEC:", durationSec);
                    console.log("MY variable x:", x);

                    urls = [
                        `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
                    ];
                    pollForResults();
                    if (mediaRecorder.state === 'recording') mediaRecorder.stop();
                    stopBtn.disabled = true;
                    startBtn.disabled = false;
                };
            }, 30000);
        };

        stopBtn.onclick = () => {
            stopTime = Date.now();
            const durationMs = stopTime - startTime;
            const durationSec = durationMs / 1000;
            const x = Math.floor(durationSec / 0.5) - 1; // number of 30-second segments
            console.log("Start time", startTime);
            console.log("Stop time", stopTime);
            console.log("DURATION IN MS:", durationMs);
            console.log("DURATION IN SEC:", durationSec);
            console.log("MY variable x:", x);

            urls = [
                `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${idStartTime}/all_results.json`
            ];
            pollForResults(interval = 10000, maxAttempts = 60, num_of_frames = x);
            if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            stopBtn.disabled = true;
            startBtn.disabled = false;
        };

        // Functions to fetch json results and display it.
        async function tryFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                return null;
            }
        }

        async function pollForResults(interval = 10000, maxAttempts = 60, num_of_frames) {
            let attempts = 0;

            while (attempts < maxAttempts) {
                for (const url of urls) {
                    const data = await tryFetch(url);
                    if (data) {
                        if (data.length === num_of_frames) {
                            const uniqueIds = new Set();
                            data.forEach(frame => {
                                frame.tracker_ids.forEach(id => uniqueIds.add(id));
                            });
                            const count = uniqueIds.size;
                            document.getElementById("bottle-count").textContent =
                                `üçº Total bottles detected: ${count}`;
                            return;
                        }
                    }
                }
                attempts++;
                console.log(`üîÑ Attempt ${attempts}: JSON not yet available`);
                await new Promise(resolve => setTimeout(resolve, interval));
            }

            document.getElementById("bottle-count").textContent =
                "‚ö†Ô∏è Detection results not found after waiting.";
        }


        // Function to get the right date and time id for fetching.
        function getFormattedTimestamp() {
            // get the current time and store it in a variable.
            let now = new Date();
            // move the time ahead 7 hours to account for time difference.
            now.setHours(now.getHours() + 7)
            //  move the month ahead 1 month (to account for a zero based index)
            now.setMonth(now.getMonth() + 1);
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()).padStart(2, '0'); // Months are 0-indexed
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const sec = String(now.getSeconds()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd}_${hh}-${min}-${sec}`;
        }

    </script>
</body>

</html>