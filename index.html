<!DOCTYPE html>
<html>

<head>
    <title>FootAge Recorder</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
    <h1>Record Your Walk</h1>
    <video id="preview" autoplay muted></video>
    <br>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <h2>Detection Summary</h2>
    <div id="bottle-count">Loading...</div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const preview = document.getElementById('preview');

        let stopTime
        let stopTime2

        startBtn.onclick = async () => {
            recordedChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: true });
            preview.srcObject = stream;

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const formData = new FormData();
                formData.append('video', blob, 'walk_video.webm');

                // ‚úÖ This is where your fetch() call goes
                fetch('https://footage-backend.onrender.com/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.text())
                    .then(data => alert('‚úÖ Video uploaded and processed'))
                    .catch(error => alert('‚ùå Upload failed: ' + error));
            };

            mediaRecorder.start();
            stopBtn.disabled = false;
            startBtn.disabled = true;

            setTimeout(() => {
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    stopTime = getFormattedTimestamp();
                    console.log("MY STOPTIME", stopTime);
                    stopTime2 = getFormattedTimestamp2();
                    console.log("MY STOPTIME", stopTime2);
                    urls = [
                        `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime}/all_results.json`,
                        `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime2}/all_results.json`
                    ];
                    pollForResults();
                }
            }, 30000);
        };

        stopBtn.onclick = () => {
            stopTime = getFormattedTimestamp();
            console.log("MY STOPTIME", stopTime);
            stopTime2 = getFormattedTimestamp2();
            console.log("MY STOPTIME", stopTime2);
            urls = [
                `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime}/all_results.json`,
                `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime2}/all_results.json`
            ];
            pollForResults();
            if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            stopBtn.disabled = true;
            startBtn.disabled = false;
        };

        // Fetching json results and displaying it.
        let urls = [
            `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime}/all_results.json`,
            `https://plastic-bottle-detector-images.s3.amazonaws.com/results/JSONResult-${stopTime2}/all_results.json`
        ];
        console.log("MY URLS", urls);

        async function tryFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                return null;
            }
        }

        async function pollForResults(interval = 10000, maxAttempts = 60) {
            let attempts = 0;

            while (attempts < maxAttempts) {
                for (const url of urls) {
                    const data = await tryFetch(url);
                    if (data) {
                        const count = data.reduce((sum, frame) => sum + frame.unique_bottles, 0);
                        document.getElementById("bottle-count").textContent =
                            `üçº Total bottles detected: ${count}`;
                        return;
                    }
                }

                attempts++;
                console.log(`üîÑ Attempt ${attempts}: JSON not yet available`);
                await new Promise(resolve => setTimeout(resolve, interval));
            }

            document.getElementById("bottle-count").textContent =
                "‚ö†Ô∏è Detection results not found after waiting.";
        }



        // function to get the right date and time for fetching.
        function getFormattedTimestamp() {
            // get the current time and store it in a variable.
            let now = new Date();
            // move the time ahead 7 hours to account for time difference.
            now.setHours(now.getHours() + 7)
            //  move the month ahead 1 month (to account for a zero based index)
            now.setMonth(now.getMonth() + 1);
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()).padStart(2, '0'); // Months are 0-indexed
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd}_${hh}-${min}`;
        }
        function getFormattedTimestamp2() {
            // get the current time and store it in a variable.
            let now = new Date();
            // move the time ahead 7 hours.
            now.setHours(now.getHours() + 7)
            // move the minutes ahead 1 minute.
            now.setMinutes(now.getMinutes() + 1)
            // move the month ahead 1 month (to account for a zero based index)
            now.setMonth(now.getMonth() + 1);
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()).padStart(2, '0'); // Months are 0-indexed
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');

            return `${yyyy}-${mm}-${dd}_${hh}-${min}`;
        }

    </script>
</body>

</html>